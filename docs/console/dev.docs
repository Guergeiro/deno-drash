#!/bin/bash

(
  for pid in $(ps aux | grep 'docs.ts' | grep 'allow' | awk '{print $2}'); do
    echo "[watchmedo] Killing $pid"
    kill -9 $pid
  done

  export DRASH_DIR_EXAMPLE_CODE="$DRASH_DIR_ROOT/docs/src/example_code"
  export DRASH_CORE_LOGGER_ENABLED="true"
  export DRASH_CORE_LOGGER_LEVEL="error"

  if [[ $1 == "restart" ]]; then
    echo -e "[watchmedo] Restarting docs.ts app..."
  else
    echo -e "[watchmedo] Starting docs.ts app..."
  fi
  # FIXME(crookse) Shouldn't need to do this twice
  deno $DRASH_DIR_ROOT/docs/docs.ts --allow-net --allow-env --allow-read --allow-write &
  for pid in $(ps aux | grep 'docs.ts' | grep 'allow' | awk '{print $2}'); do
    echo "[watchmedo] Killing $pid"
    kill -9 $pid
  done
  deno $DRASH_DIR_ROOT/docs/docs.ts --allow-net --allow-env --allow-read --allow-write &

  echo -e "[watchmedo] docs.ts app started."
  echo -e "\n[watchmedo] !!! IMPORTANT !!!"
  echo -e "[watchmedo] [ctrl] + [c] will NOT kill the docs.ts app. Run \`npm run dev-kill\` to kill the app.\n"

  if [[ -z $1 ]]; then
    echo -e "[watchmedo] Don't forget to run the following:"
    echo -e "    \`npm run webpack-dev-watch\`"
    echo -e ""
  fi
)
